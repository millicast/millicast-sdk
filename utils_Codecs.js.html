<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: utils/Codecs.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Millicast SDK</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Director.html">Director</a></div><div class="sidebar-section-children"><a href="module-Logger.html">Logger</a></div><div class="sidebar-section-children"><a href="module-SdpParser.html">SdpParser</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html">BaseWebRTC</a></div><div class="sidebar-section-children"><a href="PeerConnection.html">PeerConnection</a></div><div class="sidebar-section-children"><a href="Publish.html">Publish</a></div><div class="sidebar-section-children"><a href="Signaling.html">Signaling</a></div><div class="sidebar-section-children"><a href="View.html">View</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-events"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:connectionStateChange">connectionStateChange</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:track">track</a></div><div class="sidebar-section-children"><a href="Publish.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:broadcastEvent">broadcastEvent</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionClose">wsConnectionClose</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionError">wsConnectionError</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionSuccess">wsConnectionSuccess</a></div><div class="sidebar-section-children"><a href="View.html#event:reconnect">reconnect</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AudioCodec">AudioCodec</a></div><div class="sidebar-section-children"><a href="global.html#ConnectionStats">ConnectionStats</a></div><div class="sidebar-section-children"><a href="global.html#DirectorPublisherOptions">DirectorPublisherOptions</a></div><div class="sidebar-section-children"><a href="global.html#DirectorSubscriberOptions">DirectorSubscriberOptions</a></div><div class="sidebar-section-children"><a href="global.html#FrameMetaData">FrameMetaData</a></div><div class="sidebar-section-children"><a href="global.html#InboundStats">InboundStats</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LogLevel">LogLevel</a></div><div class="sidebar-section-children"><a href="global.html#MillicastCapability">MillicastCapability</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#OutboundStats">OutboundStats</a></div><div class="sidebar-section-children"><a href="global.html#SEIPicTimingTimeCode">SEIPicTimingTimeCode</a></div><div class="sidebar-section-children"><a href="global.html#SEIUserUnregisteredData">SEIUserUnregisteredData</a></div><div class="sidebar-section-children"><a href="global.html#SignalingPublishOptions">SignalingPublishOptions</a></div><div class="sidebar-section-children"><a href="global.html#SignalingSubscribeOptions">SignalingSubscribeOptions</a></div><div class="sidebar-section-children"><a href="global.html#TrackReport">TrackReport</a></div><div class="sidebar-section-children"><a href="global.html#VideoCodec">VideoCodec</a></div><div class="sidebar-section-children"><a href="global.html#addPeerEvents">addPeerEvents</a></div><div class="sidebar-section-children"><a href="global.html#extractH26xMetadata">extractH26xMetadata</a></div><div class="sidebar-section-children"><a href="global.html#loggerHandler">loggerHandler</a></div><div class="sidebar-section-children"><a href="global.html#parseWebRTCStats">parseWebRTCStats</a></div><div class="sidebar-section-children"><a href="global.html#tokenGeneratorCallback">tokenGeneratorCallback</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="" href="https://github.com/millicast/millicast-sdk" target="_blank">Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/@millicast/sdk" target="_blank">NPM Package</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">utils_Codecs.js</h1></header><article><pre class="prettyprint source lang-js"><code>/* eslint-disable camelcase */
import BitStreamReader from './BitStreamReader'
/**
 * Enum of Millicast supported Video codecs
 * @readonly
 * @enum {String}
 * @property {String} VP8
 * @property {String} VP9
 * @property {String} H264
 * @property {String} AV1
 * @property {String} H265 - Only available in Safari
 */
export const VideoCodec = {
  VP8: 'vp8',
  VP9: 'vp9',
  H264: 'h264',
  AV1: 'av1',
  H265: 'h265'
}

/**
 * Enum of Millicast supported Audio codecs
 * @readonly
 * @enum {String}
 * @property {String} OPUS
 * @property {String} MULTIOPUS
 */
export const AudioCodec = {
  OPUS: 'opus',
  MULTIOPUS: 'multiopus'
}

const NALUType = {
  SLICE_NON_IDR: 1,
  SLICE_PARTITION_A: 2,
  SLICE_IDR: 5,
  SEI_H264: 6,
  SEI_H265_PREFIX: 39,
  SEI_H265_SUFFIX: 40,
  SPS_H264: 7,
  SPS_H265: 33,
  PPS_H264: 8,
  PPS_H265: 34
}

const SEI_Payload_Type = {
  PIC_TIMING: 1,
  USER_DATA_UNREGISTERED: 5
}

export const DOLBY_SEI_DATA_UUID = '6e9cfd2a-5907-49ff-b363-8978a6e8340e'
export const DOLBY_SEI_TIMESTAMP_UUID = '9a21f3be-31f0-4b78-b0be-c7f7dbb97250'

class SPSState {
  constructor (codec = 'H264') {
    this.sps = new Map()
    this.pps = new Map()
    this.activeSPS = null
    this.codec = codec
  }

  collectPPS (rbsp) {
    if (this.codec === 'H264') {
      this.collectH264PPS(rbsp)
    } else {
      this.collectH265PPS(rbsp)
    }
  }

  collectSPS (rbsp) {
    if (this.codec === 'H264') {
      this.collectH264SPS(rbsp)
    } else {
      this.collectH265SPS(rbsp)
    }
  }

  collectH264SPS (rbsp) {
    const reader = new BitStreamReader(rbsp)
    const profile_idc = reader.readBits(8)
    const supported_profiles = [100, 110, 122, 244, 44, 83, 86, 118, 128, 138, 139, 134, 135]
    reader.skip(8) // skip 8bits constraint set flag and reserved_zero_2bits
    reader.skip(8) // level_idc
    const seq_parameter_set_id = reader.readExpGolombUnsigned()
    if (seq_parameter_set_id > 31 || seq_parameter_set_id &lt; 0) {
      throw new Error('Invalid seq_parameter_set_id')
    }
    if (supported_profiles.includes(profile_idc)) {
      const chroma_format_idc = reader.readExpGolombUnsigned()
      if (chroma_format_idc === 3) {
        reader.skip(1) // separate_colour_plane_flag
      }
      reader.readExpGolombUnsigned() // bit_depth_luma_minus8
      reader.readExpGolombUnsigned() // bit_depth_chroma_minus8
      reader.skip(1) // qpprime_y_zero_transform_bypass_flag
      const seq_scaling_matrix_present_flag = reader.readBits(1)
      if (seq_scaling_matrix_present_flag) {
        // parse scaling matrix, since we don't need the result, just read and skip it
        const sizeOfScalingList = (chroma_format_idc !== 3) ? 8 : 12
        for (let i = 0; i &lt; sizeOfScalingList; i++) {
          if (reader.readBits(1)) {
            const sizeOfScalingList = (i &lt; 6) ? 16 : 64
            let lastScale = 8
            let nextScale = 8
            for (let j = 0; j &lt; sizeOfScalingList; j++) {
              if (nextScale !== 0) {
                const delta_scale = reader.readExpGolombSigned()
                nextScale = (lastScale + delta_scale + 256) % 256
              }
              lastScale = nextScale === 0 ? lastScale : nextScale
            }
          }
        }
      }
    }
    reader.readExpGolombUnsigned() // log2_max_frame_num_minus4
    const pic_order_cnt_type = reader.readExpGolombUnsigned()
    if (pic_order_cnt_type === 0) {
      reader.readExpGolombUnsigned() // log2_max_pic_order_cnt_lsb_minus4
    } else if (pic_order_cnt_type === 1) {
      reader.skip(1) // delta_pic_order_always_zero_flag
      reader.readExpGolombSigned() // offset_for_non_ref_pic
      reader.readExpGolombSigned() // offset_for_top_to_bottom_field
      const num_ref_frames_in_pic_order_cnt_cycle = reader.readExpGolombUnsigned()
      for (let i = 0; i &lt; num_ref_frames_in_pic_order_cnt_cycle; i++) {
        // parse offset_for_ref_frame
        reader.readExpGolombSigned()
      }
    }
    reader.readExpGolombUnsigned() // max_num_ref_frames
    reader.skip(1) // gaps_in_frame_num_value_allowed_flag
    reader.readExpGolombUnsigned() // pic_width_in_mbs_minus1
    reader.readExpGolombUnsigned() // pic_height_in_map_units_minus1
    if (reader.readBits(1) === 0) reader.skip(1) // frame_mbs_only_flag and mb_adaptive_frame_field_flag
    reader.skip(1) // direct_8x8_inference_flag
    // parse frame_crop
    if (reader.readBits(1)) {
      reader.readExpGolombUnsigned() // frame_crop_left_offset
      reader.readExpGolombUnsigned() // frame_crop_right_offset
      reader.readExpGolombUnsigned() // frame_crop_top_offset
      reader.readExpGolombUnsigned() // frame_crop_bottom_offset
    }
    // parse vui_parameters
    let vui_parameters
    if (reader.readBits(1)) {
      // aspect_ratio_info
      if (reader.readBits(1)) {
        const aspect_ratio_idc = reader.readBits(8)
        if (aspect_ratio_idc === 255) {
          // Extended_SAR
          reader.skip(16)
          reader.skip(16)
        }
      }
      // overscan_info
      if (reader.readBits(1)) {
        reader.skip(1)
      }
      // video_signal_type
      if (reader.readBits(1)) {
        reader.skip(3) // video_format
        reader.skip(1) // video_full_range_flag
        if (reader.readBits(1)) {
          // colour_description
          reader.skip(24)
        }
      }
      // chroma_loc_info
      if (reader.readBits(1)) {
        reader.readExpGolombUnsigned() // chroma_sample_loc_type_top_field
        reader.readExpGolombUnsigned() // chroma_sample_loc_type_bottom_field
      }
      // timing_info
      const timing_info = reader.readBits(1)
        ? {
            num_units_in_tick: reader.readBits(32),
            time_scale: reader.readBits(32),
            fixed_frame_rate_flag: reader.readBits(1)
          }
        : undefined

      function parseHRDParameters (reader) {
        const cpb_cnt_minus1 = reader.readExpGolombUnsigned()
        reader.skip(4) // bit_rate_scale
        reader.skip(4) // cpb_size_scale
        for (let i = 0; i &lt;= cpb_cnt_minus1; i++) {
          reader.readExpGolombUnsigned() // bit_rate_value_minus1
          reader.readExpGolombUnsigned() // cpb_size_value_minus1
          reader.skip(1) // cbr_flag
        }
        reader.skip(5) // initial_cpb_removal_delay_length_minus1
        const cpb_removal_delay_length_minus1 = reader.readBits(5)
        const dpb_output_delay_length_minus1 = reader.readBits(5)
        const time_offset_length = reader.readBits(5)
        return {
          cpb_removal_delay_length_minus1,
          dpb_output_delay_length_minus1,
          time_offset_length
        }
      }

      const nal_hrd_parameters = reader.readBits(1) ? parseHRDParameters(reader) : undefined
      const vcl_hrd_parameters = reader.readBits(1) ? parseHRDParameters(reader) : undefined
      if (nal_hrd_parameters || vcl_hrd_parameters) {
        reader.skip(1) // low_delay_hrd_flag
      }
      const pic_struct_present_flag = reader.readBits(1)
      vui_parameters = {
        timing_info,
        nal_hrd_parameters,
        vcl_hrd_parameters,
        pic_struct_present_flag
      }
    }
    this.sps.set(seq_parameter_set_id, {
      vui_parameters
    })
  }

  collectH265SPS (rbsp) {
    // TODO: parse H265 SPS
  }

  collectH264PPS (rbsp) {
    const reader = new BitStreamReader(rbsp)
    const pic_parameter_set_id = reader.readExpGolombUnsigned()
    if (pic_parameter_set_id > 255 || pic_parameter_set_id &lt; 0) {
      throw new Error('Invalid pic_parameter_set_id')
    }
    const seq_parameter_set_id = reader.readExpGolombUnsigned()
    this.pps.set(pic_parameter_set_id, {
      seq_parameter_set_id
    })
  }

  collectH265PPS (rbsp) {
    // TODO: parse H265 PPS
  }

  findActiveSPS (rbsp) {
    // get the seq_parameter_set_id from the slice header
    const reader = new BitStreamReader(rbsp)
    reader.readExpGolombUnsigned() // first_mb_in_slice
    reader.readExpGolombUnsigned() // slice_type
    const pic_parameter_set_id = reader.readExpGolombUnsigned()
    const pps = this.pps.get(pic_parameter_set_id)
    if (pps) {
      const sps = this.sps.get(pps.seq_parameter_set_id)
      if (sps) {
        this.activeSPS = sps
        return
      }
    }
    throw new Error('Cannot find the active SPS')
  }
}

const spsState = new SPSState()

function findStartCodeIndex (frameBuffer, offset) {
  while (offset &lt; frameBuffer.byteLength - 4) {
    if ((frameBuffer[offset] === 0x00 &amp;&amp; frameBuffer[offset + 1] === 0x00) &amp;&amp;
        (frameBuffer[offset + 2] === 0x01 ||
        (frameBuffer[offset + 2] === 0x00 &amp;&amp; frameBuffer[offset + 3] === 0x01))) {
      return offset
    } else {
      offset += 1
    }
  }
  return -1
}

// EBSP (Encapsulate Byte Sequence Payload) is a sequence of bytes without start code and header in NAL unit
// which is also aka ...RBSP (Raw Byte Sequence Payload) + 0x03 when there are [0x00, 0x00, &lt;0x01 or 0x02 or 0x03>] in RBSP
// so we need to remove 0x03 byte before we parse the payload data
function removePreventionBytes (ebsp) {
  const output = new Uint8Array(ebsp.byteLength)
  let outOffset = 0
  let ebspOffset = 0
  for (let preventionByteIdx = 2; preventionByteIdx &lt; ebsp.byteLength; preventionByteIdx++) {
    if (ebsp[preventionByteIdx] === 0x03 &amp;&amp; ebsp[preventionByteIdx - 1] === 0x00 &amp;&amp; ebsp[preventionByteIdx - 2] === 0x00) {
      output.set(ebsp.subarray(ebspOffset, preventionByteIdx), outOffset)
      outOffset += preventionByteIdx - ebspOffset
      ebspOffset = preventionByteIdx + 1
    }
  }
  if (ebspOffset &lt; ebsp.byteLength) {
    output.set(ebsp.subarray(ebspOffset), outOffset)
  }
  return output
}

function getNalus (frameBuffer, codec) {
  let offset = 0
  const headerSize = codec === 'H264' ? 1 : 2
  const nalus = []
  while (offset &lt; frameBuffer.byteLength - 4) {
    const startCodeIndex = findStartCodeIndex(frameBuffer, offset)
    if (startCodeIndex >= offset) {
      // found the NAL unit start code
      const startCodeLength = frameBuffer[startCodeIndex + 2] === 0x01 ? 3 : 4
      // find the start index of next NAL unit
      const nextStartCodeIndex = findStartCodeIndex(frameBuffer, startCodeIndex + startCodeLength + headerSize)
      if (nextStartCodeIndex > startCodeIndex) {
        nalus.push(frameBuffer.subarray(startCodeIndex, nextStartCodeIndex))
        offset = nextStartCodeIndex
      } else {
        nalus.push(frameBuffer.subarray(startCodeIndex))
        break
      }
    } else {
      break
    }
  }
  return nalus
}

function getSeiNalus (frameBuffer, codec) {
  let shouldSearchActiveSPS = true
  return getNalus(frameBuffer, codec).filter((nalu) => {
    const startCodeLength = nalu[2] === 0x01 ? 3 : 4
    const headerLength = codec === 'H264' ? 1 : 2
    const header = nalu[startCodeLength]
    const naluType = codec === 'H264' ? header &amp; 0x1f : header >> 1 &amp; 0x3f
    if (shouldSearchActiveSPS) {
      switch (naluType) {
        case NALUType.PPS_H264:
        case NALUType.PPS_H265:
          spsState.collectPPS(removePreventionBytes(nalu.subarray(startCodeLength + headerLength)))
          break
        case NALUType.SPS_H264:
        case NALUType.SPS_H265:
          spsState.collectSPS(removePreventionBytes(nalu.subarray(startCodeLength + headerLength)))
          break
        case NALUType.SLICE_IDR:
        case NALUType.SLICE_NON_IDR:
        case NALUType.SLICE_PARTITION_A:
          try {
            spsState.findActiveSPS(removePreventionBytes(nalu.subarray(startCodeLength + headerLength)))
            shouldSearchActiveSPS = false
          } catch (err) {
            console.info('Failed to find active SPS. Will not be able to extract PIC timing metadata')
          }
          break
        default:
          break
      }
    }
    return [NALUType.SEI_H264, NALUType.SEI_H265_PREFIX, NALUType.SEI_H265_SUFFIX].includes(naluType)
  })
}

function extractSEIPayload (rbsp) {
  let payloadType = 0
  let idx = 0
  while (rbsp[idx] === 0xff) {
    payloadType += 0xff
    idx++
  }
  payloadType += rbsp[idx]
  idx++
  let payloadSize = 0
  while (rbsp[idx] === 0xff) {
    payloadSize += 0xff
    idx++
  }
  payloadSize += rbsp[idx]
  idx++
  return {
    type: payloadType,
    content: rbsp.subarray(idx, idx + payloadSize)
  }
}

function getSeiUserUnregisteredData (metadata, payloadContent) {
  let idx = 0
  metadata.uuid = payloadContent.subarray(idx, idx + 16)
  idx += 16
  const content = payloadContent.subarray(idx)
  if (isUUIDTimestamp(metadata.uuid)) {
    metadata.timecode = convertSEITimestamp(content)
  } else {
    metadata.unregistered = content
  }
}

function isUUIDTimestamp (uuidToCheck) {
  const dolbyUUID = new Uint8Array(parseUUID(DOLBY_SEI_TIMESTAMP_UUID))

  return dolbyUUID.every((value, index) => value === uuidToCheck[index])
}

function convertSEITimestamp (data) {
  const timestampBigInt = data.reduce((acc, byte) => (acc &lt;&lt; 8n) + BigInt(byte), 0n)
  const milliseconds = Number(timestampBigInt)
  const date = new Date(milliseconds)
  const dateEncoded = new TextEncoder().encode(date.toISOString())
  return dateEncoded
}

function getSeiPicTimingTimecode (metadata, payloadContent) {
  if (!spsState.activeSPS) {
    throw new Error('Cannot find the active SPS')
  }
  const hrdParameters = spsState.activeSPS.vui_parameters.nal_hrd_parameters ?? spsState.activeSPS.vui_parameters.vcl_hrd_parameters
  const options = {
    cpb_dpb_delays_present_flag: hrdParameters ? 1 : 0,
    cpb_removal_delay_length_minus1: hrdParameters?.cpb_removal_delay_length_minus1 ?? 23,
    dpb_output_delay_length_minus1: hrdParameters?.dpb_output_delay_length_minus1 ?? 23,
    time_offset_length: hrdParameters ? hrdParameters.time_offset_length ?? 24 : undefined,
    pic_struct_present_flag: spsState.activeSPS.vui_parameters.pic_struct_present_flag ?? 0
  }
  if (!options.pic_struct_present_flag) {
    console.warn('pic_struct_present_flag is not present')
    return undefined
  }
  const reader = new BitStreamReader(payloadContent)
  if (options.cpb_dpb_delays_present_flag) {
    reader.skip(options.cpb_removal_delay_length_minus1 + 1) // cpb_removal_delay
    reader.skip(options.dpb_output_delay_length_minus1 + 1) // dpb_output_delay
  }

  const picStructNumClockTS = [1, 1, 1, 2, 2, 3, 3, 2, 3]
  const pic_struct = reader.readBits(4)
  if (pic_struct >= picStructNumClockTS.length) {
    throw new Error('Invalid pic_struct')
  }
  const numClockTS = picStructNumClockTS[pic_struct]
  const timecodes = []
  for (let i = 0; i &lt; numClockTS; i++) {
    const clock_timestamp_flag = reader.readBits(1)
    if (clock_timestamp_flag) {
      const timecode = {}
      reader.skip(2) // ct_type
      reader.skip(1) // nuit_field_based_flag
      reader.skip(5) // counting_type
      const full_timestamp_flag = reader.readBits(1)
      reader.skip(2) // discontinuity_flag, cnt_dropped_flag
      timecode.n_frames = reader.readBits(8)
      if (full_timestamp_flag) {
        timecode.seconds_value = reader.readBits(6)
        timecode.minutes_value = reader.readBits(6)
        timecode.hours_value = reader.readBits(5)
      } else {
        const seconds_flag = reader.readBits(1)
        if (seconds_flag) {
          timecode.seconds_value = reader.readBits(6)
          const minutes_flag = reader.readBits(1)
          if (minutes_flag) {
            timecode.minutes_value = reader.readBits(6)
            const hours_flag = reader.readBits(1)
            if (hours_flag) {
              timecode.hours_value = reader.readBits(5)
            }
          }
        }
      }
      if (options.time_offset_length) {
        try {
          timecode.time_offset = reader.readBits(options.time_offset_length)
        } catch (err) {
          console.error('Failed to read time_offset', err)
          timecode.time_offset = 0
        }
      } else {
        timecode.time_offset = 0
      }
      timecodes.push(timecode)
    }
  }
  metadata.seiPicTimingTimeCodeArray = timecodes
}

/**
 * SEI User unregistered data
 * @typedef {object} SEIUserUnregisteredData
 * @global
 * @property {string} uuid - the UUID of the SEI user unregistered data
 * @property {Uint8Array} data - the binary content of the SEI user unregistered data
 */

/**
 * SEI Pic timing time code
 * @typedef {object} SEIPicTimingTimeCode
 * @global
 * @property {number} seconds
 * @property {number} minutes
 * @property {number} hours
 * @property {number} n_frames
 * @property {number} time_offset
 */

/**
 * Metadata of the Encoded Frame
 * @typedef {object} FrameMetaData
 * @global
 * @property {number} timestamp - the time at which frame sampling started, value is a positive integer containing the sampling instant of the first byte in this frame, in microseconds
 * @property { Array&lt;SEIUserUnregisteredData> } seiUserUnregisteredDataArray - the SEI user unregistered data array
 * @property { Array&lt;SEIPicTimingTimeCode> } [seiPicTimingTimeCodeArray] - the SEI pic timing time codes
 */

/**
* Extract user unregistered metadata from H26x Encoded Frame
* @param { RTCEncodedFrame } encodedFrame
* @param { 'H264' | 'H265' } codec
* @returns { FrameMetaData }
*/
export function extractH26xMetadata (encodedFrame, codec) {
  if (codec !== 'H264' &amp;&amp; codec !== 'H265') {
    throw new Error(`Unsupported codec ${codec}`)
  }
  const metadata = {}
  spsState.codec = codec
  getSeiNalus(new Uint8Array(encodedFrame.data), codec).forEach((nalu) => {
    const startCodeLength = nalu[2] === 0x01 ? 3 : 4
    const headerLength = codec === 'H264' ? 1 : 2
    const rbsp = removePreventionBytes(nalu.subarray(startCodeLength + headerLength))
    const payload = extractSEIPayload(rbsp)
    switch (payload.type) {
      case SEI_Payload_Type.PIC_TIMING:
        getSeiPicTimingTimecode(metadata, payload.content)
        break
      case SEI_Payload_Type.USER_DATA_UNREGISTERED:
        getSeiUserUnregisteredData(metadata, payload.content)
        break
      default:
        break
    }
  })
  return metadata
}

function isValidUUID (uuid) {
  const uuidRegEx = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/
  return uuidRegEx.test(uuid)
}

function parseUUID (uuid) {
  return uuid.replace(/-/g, '')
    .match(/.{1,2}/g)
    .map(byte => parseInt(byte, 16))
}

function createSEIMessageContent (uuid, payload) {
  const uuidArray = new Uint8Array(parseUUID(uuid))
  const payloadArray = new TextEncoder().encode(JSON.stringify(payload))

  const content = new Uint8Array(uuidArray.length + payloadArray.length)
  content.set(uuidArray)
  content.set(payloadArray, uuidArray.length)

  return content
}

function createSEITypeAndSize (content) {
  const payloadSize = []
  const ffBytes = Math.floor(content.byteLength / 255)
  const lastPayloadTypeByte = content.byteLength % 255
  for (let i = 0; i &lt; ffBytes; i++) {
    payloadSize.push(0xFF)
  }
  payloadSize.push(lastPayloadTypeByte)

  return new Uint8Array([0x05, ...payloadSize])
}

function createSEIMessageContentWithPrevensionBytes (content) {
  const preventionByteArray = []

  for (let i = 0; i &lt; content.byteLength; i++) {
    if (i + 2 &lt; content.byteLength &amp;&amp; [0x00, 0x01, 0x02, 0x03].includes(content[i + 2]) &amp;&amp; content[i] === 0x00 &amp;&amp; content[i + 1] === 0x00) {
      preventionByteArray.push(content[i])
      preventionByteArray.push(content[i + 1])
      i += 2
      preventionByteArray.push(0x03)
    } else {
      preventionByteArray.push(content[i])
    }
  }

  // trailing bits
  preventionByteArray.push(0x80)

  return new Uint8Array(preventionByteArray)
}

function createSEINalu ({ uuid, payload }) {
  const startCode = [0x00, 0x00, 0x00, 0x01]
  const header = [0x66] // 0b01100110
  const content = createSEIMessageContent(uuid, payload)
  const seiTypeAndSize = createSEITypeAndSize(content)
  const contentWithPreventionBytes = createSEIMessageContentWithPrevensionBytes(content)

  const naluWithSEI = new Uint8Array(startCode.length + header.length + seiTypeAndSize.length + contentWithPreventionBytes.length)
  naluWithSEI.set(startCode)
  naluWithSEI.set(header, startCode.length)
  naluWithSEI.set(seiTypeAndSize, startCode.length + header.length)
  naluWithSEI.set(contentWithPreventionBytes, startCode.length + header.length + seiTypeAndSize.length)

  return naluWithSEI
}

export function addH26xSEI ({ uuid, payload }, encodedFrame) {
  if (uuid === '' || payload === '') {
    throw new Error('uuid and payload cannot be empty')
  }
  if (!isValidUUID(uuid)) {
    console.warn('Invalid UUID. Using default UUID.')
    uuid = DOLBY_SEI_DATA_UUID
  }
  // Case of NALU H264 - User Unregistered Data
  const naluWithSEI = createSEINalu({ uuid, payload })

  const encodedFrameView = new DataView(encodedFrame.data)
  const encodedFrameWithSEI = new ArrayBuffer(encodedFrame.data.byteLength + naluWithSEI.byteLength)
  const encodedFrameWithSEIView = new DataView(encodedFrameWithSEI)

  for (let i = 0; i &lt; encodedFrame.data.byteLength; i++) {
    encodedFrameWithSEIView.setUint8(i, encodedFrameView.getUint8(i))
  }
  for (let i = 0; i &lt; naluWithSEI.byteLength; i++) {
    encodedFrameWithSEIView.setUint8(encodedFrame.data.byteLength + i, naluWithSEI[i])
  }

  encodedFrame.data = encodedFrameWithSEI
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Millicast SDK</a><div class="mobile-nav-links"><div class="navbar-item"><a id="" href="https://github.com/millicast/millicast-sdk" target="_blank">Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/@millicast/sdk" target="_blank">NPM Package</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Director.html">Director</a></div><div class="sidebar-section-children"><a href="module-Logger.html">Logger</a></div><div class="sidebar-section-children"><a href="module-SdpParser.html">SdpParser</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html">BaseWebRTC</a></div><div class="sidebar-section-children"><a href="PeerConnection.html">PeerConnection</a></div><div class="sidebar-section-children"><a href="Publish.html">Publish</a></div><div class="sidebar-section-children"><a href="Signaling.html">Signaling</a></div><div class="sidebar-section-children"><a href="View.html">View</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-events"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:connectionStateChange">connectionStateChange</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:track">track</a></div><div class="sidebar-section-children"><a href="Publish.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:broadcastEvent">broadcastEvent</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionClose">wsConnectionClose</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionError">wsConnectionError</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionSuccess">wsConnectionSuccess</a></div><div class="sidebar-section-children"><a href="View.html#event:reconnect">reconnect</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AudioCodec">AudioCodec</a></div><div class="sidebar-section-children"><a href="global.html#ConnectionStats">ConnectionStats</a></div><div class="sidebar-section-children"><a href="global.html#DirectorPublisherOptions">DirectorPublisherOptions</a></div><div class="sidebar-section-children"><a href="global.html#DirectorSubscriberOptions">DirectorSubscriberOptions</a></div><div class="sidebar-section-children"><a href="global.html#FrameMetaData">FrameMetaData</a></div><div class="sidebar-section-children"><a href="global.html#InboundStats">InboundStats</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LogLevel">LogLevel</a></div><div class="sidebar-section-children"><a href="global.html#MillicastCapability">MillicastCapability</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#OutboundStats">OutboundStats</a></div><div class="sidebar-section-children"><a href="global.html#SEIPicTimingTimeCode">SEIPicTimingTimeCode</a></div><div class="sidebar-section-children"><a href="global.html#SEIUserUnregisteredData">SEIUserUnregisteredData</a></div><div class="sidebar-section-children"><a href="global.html#SignalingPublishOptions">SignalingPublishOptions</a></div><div class="sidebar-section-children"><a href="global.html#SignalingSubscribeOptions">SignalingSubscribeOptions</a></div><div class="sidebar-section-children"><a href="global.html#TrackReport">TrackReport</a></div><div class="sidebar-section-children"><a href="global.html#VideoCodec">VideoCodec</a></div><div class="sidebar-section-children"><a href="global.html#addPeerEvents">addPeerEvents</a></div><div class="sidebar-section-children"><a href="global.html#extractH26xMetadata">extractH26xMetadata</a></div><div class="sidebar-section-children"><a href="global.html#loggerHandler">loggerHandler</a></div><div class="sidebar-section-children"><a href="global.html#parseWebRTCStats">parseWebRTCStats</a></div><div class="sidebar-section-children"><a href="global.html#tokenGeneratorCallback">tokenGeneratorCallback</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>