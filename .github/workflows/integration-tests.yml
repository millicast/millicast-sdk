name: New Test Suite

on:
  pull_request:

jobs:
  new-integration-tests-STG:
    runs-on: ubuntu-latest
    env:
      INTEGRATION_DIR: ./packages/millicast-sdk/integration-tests
      INTEGRATION_TEST_CONFIG: ./packages/millicast-sdk/integration-tests/test.config.json

      VITE_ACCOUNT_ID: ${{secrets.STG_MILLICAST_ACCOUNT_ID}}
      VITE_DIRECTOR_ENDPOINT: ${{vars.STG_MILLICAST_DIRECTOR_EP}}
      MILLICAST_API_ENDPOINT: ${{vars.STG_MILLICAST_API_EP}}
      MILLICAST_API_SECRET: ${{secrets.STG_MILLICAST_API_SECRET}}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-install
      - name: Suite Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y moreutils
          sudo apt-get --only-upgrade install google-chrome-stable
          npm install playwright

          NEW_TOKEN=$(./../../packages/millicast-sdk/integration-tests/ci/createToken.sh ${MILLICAST_API_ENDPOINT} ${MILLICAST_API_SECRET})
          VITE_PUBLISH_TOKEN=$(echo $NEW_TOKEN | jq -r '.data.token')
          VITE_STREAM_NAME=$(echo $NEW_TOKEN | jq -r '.data.streams[0].streamName')
          NEW_TOKEN_ID=$(echo $NEW_TOKEN | jq -r '.data.id')

          npm run build
          npm run demo-app:setup
      - name: Execute Test Suite
        run: |
          # Disable artifact collection
          jq '.video = "off"' ${INTEGRATION_TEST_CONFIG} | sponge ${INTEGRATION_TEST_CONFIG}
          jq '.trace = "off"' ${INTEGRATION_TEST_CONFIG} | sponge ${INTEGRATION_TEST_CONFIG}
          jq '.har = "off"' ${INTEGRATION_TEST_CONFIG} | sponge ${INTEGRATION_TEST_CONFIG}

          npm run test-websdk -- tags "not @skip and not @ignore"
      - name: Suite Teardown
        if: always()
        run: |
          npm run demo-app:teardown
          npm run test:report
          ./../../packages/millicast-sdk/integration-tests/ci/deleteToken.sh ${MILLICAST_API_ENDPOINT} ${MILLICAST_API_SECRET} ${NEW_TOKEN_ID}
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-artifacts
          path: ./packages/millicast-sdk/integration-tests/test-reports/
          retention-days: 2
