<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: utils/SdpParser.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Millicast SDK</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Director.html">Director</a></div><div class="sidebar-section-children"><a href="module-Logger.html">Logger</a></div><div class="sidebar-section-children"><a href="module-SdpParser.html">SdpParser</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html">BaseWebRTC</a></div><div class="sidebar-section-children"><a href="PeerConnection.html">PeerConnection</a></div><div class="sidebar-section-children"><a href="Publish.html">Publish</a></div><div class="sidebar-section-children"><a href="Signaling.html">Signaling</a></div><div class="sidebar-section-children"><a href="View.html">View</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-events"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:connectionStateChange">connectionStateChange</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:track">track</a></div><div class="sidebar-section-children"><a href="Publish.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:broadcastEvent">broadcastEvent</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionClose">wsConnectionClose</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionError">wsConnectionError</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionSuccess">wsConnectionSuccess</a></div><div class="sidebar-section-children"><a href="View.html#event:metadata">metadata</a></div><div class="sidebar-section-children"><a href="View.html#event:reconnect">reconnect</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AudioCodec">AudioCodec</a></div><div class="sidebar-section-children"><a href="global.html#ConnectionStats">ConnectionStats</a></div><div class="sidebar-section-children"><a href="global.html#DRMOptions">DRMOptions</a></div><div class="sidebar-section-children"><a href="global.html#DirectorPublisherOptions">DirectorPublisherOptions</a></div><div class="sidebar-section-children"><a href="global.html#DirectorSubscriberOptions">DirectorSubscriberOptions</a></div><div class="sidebar-section-children"><a href="global.html#FrameMetaData">FrameMetaData</a></div><div class="sidebar-section-children"><a href="global.html#InboundStats">InboundStats</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LogLevel">LogLevel</a></div><div class="sidebar-section-children"><a href="global.html#MillicastCapability">MillicastCapability</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#OutboundStats">OutboundStats</a></div><div class="sidebar-section-children"><a href="global.html#PeerConnectionConfig">PeerConnectionConfig</a></div><div class="sidebar-section-children"><a href="global.html#SEIPicTimingTimeCode">SEIPicTimingTimeCode</a></div><div class="sidebar-section-children"><a href="global.html#SEIUserUnregisteredData">SEIUserUnregisteredData</a></div><div class="sidebar-section-children"><a href="global.html#SignalingPublishOptions">SignalingPublishOptions</a></div><div class="sidebar-section-children"><a href="global.html#SignalingSubscribeOptions">SignalingSubscribeOptions</a></div><div class="sidebar-section-children"><a href="global.html#TrackReport">TrackReport</a></div><div class="sidebar-section-children"><a href="global.html#VideoCodec">VideoCodec</a></div><div class="sidebar-section-children"><a href="global.html#addPeerEvents">addPeerEvents</a></div><div class="sidebar-section-children"><a href="global.html#extractH26xMetadata">extractH26xMetadata</a></div><div class="sidebar-section-children"><a href="global.html#loggerHandler">loggerHandler</a></div><div class="sidebar-section-children"><a href="global.html#parseWebRTCStats">parseWebRTCStats</a></div><div class="sidebar-section-children"><a href="global.html#tokenGeneratorCallback">tokenGeneratorCallback</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="" href="https://github.com/millicast/millicast-sdk" target="_blank">Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/@millicast/sdk" target="_blank">NPM Package</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">utils_SdpParser.js</h1></header><article><pre class="prettyprint source lang-js"><code>import { SDPInfo, MediaInfo, Direction } from 'semantic-sdp'
import Logger from '../Logger'
import UserAgent from './UserAgent'

const logger = Logger.get('SdpParser')

const firstPayloadTypeLowerRange = 35
const lastPayloadTypeLowerRange = 65

const firstPayloadTypeUpperRange = 96
const lastPayloadTypeUpperRange = 127

const payloadTypeLowerRange = Array.from({ length: (lastPayloadTypeLowerRange - firstPayloadTypeLowerRange) + 1 }, (_, i) => i + firstPayloadTypeLowerRange)
const payloadTypeUppperRange = Array.from({ length: (lastPayloadTypeUpperRange - firstPayloadTypeUpperRange) + 1 }, (_, i) => i + firstPayloadTypeUpperRange)

const firstHeaderExtensionIdLowerRange = 1
const lastHeaderExtensionIdLowerRange = 14

const firstHeaderExtensionIdUpperRange = 16
const lastHeaderExtensionIdUpperRange = 255

const headerExtensionIdLowerRange = Array.from({ length: (lastHeaderExtensionIdLowerRange - firstHeaderExtensionIdLowerRange) + 1 }, (_, i) => i + firstHeaderExtensionIdLowerRange)
const headerExtensionIdUppperRange = Array.from({ length: (lastHeaderExtensionIdUpperRange - firstHeaderExtensionIdUpperRange) + 1 }, (_, i) => i + firstHeaderExtensionIdUpperRange)

/**
 * @module SdpParser
 * @description Simplify SDP parser.
 */
const SdpParser = {
  /**
   * @function
   * @name setSimulcast
   * @description Parse SDP for support simulcast.
   * **Only available in Chromium based browsers.**
   * @param {String} sdp - Current SDP.
   * @param {String} codec - Codec.
   * @returns {String} SDP parsed with simulcast support.
   * @example SdpParser.setSimulcast(sdp, 'h264')
   */
  setSimulcast (sdp, codec) {
    logger.info('Setting simulcast. Codec: ', codec)
    const browserData = new UserAgent()
    if (!browserData.isChromium()) {
      logger.warn('Your browser does not appear to support Simulcast. For a better experience, use a Chromium based browser.')
      return sdp
    }
    if (codec !== 'h264' &amp;&amp; codec !== 'vp8') {
      logger.warn(`Your selected codec ${codec} does not appear to support Simulcast.  To broadcast using simulcast, please use H.264 or VP8.`)
      return sdp
    }
    // Check if there is video available to set simulcast
    if (!/m=video/.test(sdp)) {
      logger.warn('There is no available video for simulcast to be enabled.')
      return sdp
    }

    try {
      const reg1 = /m=video.*?a=ssrc:(\d*) cname:(.+?)\r\n/s
      const reg2 = /m=video.*?a=ssrc:(\d*) msid:(.+?)\r\n/s
      // Get ssrc and cname and msid
      const res = reg1.exec(sdp)
      const ssrc = res[1]
      const cname = res[2]
      const msid = reg2.exec(sdp)[2]
      // Add simulcasts ssrcs
      const num = 2
      const ssrcs = [ssrc]
      for (let i = 0; i &lt; num; ++i) {
        // Create new ssrcs
        const ssrc = 100 + i * 2
        const rtx = ssrc + 1
        // Add to ssrc list
        ssrcs.push(ssrc)
        // Add sdp stuff
        sdp += 'a=ssrc-group:FID ' + ssrc + ' ' + rtx + '\r\n' +
            'a=ssrc:' + ssrc + ' cname:' + cname + '\r\n' +
            'a=ssrc:' + ssrc + ' msid:' + msid + '\r\n' +
            'a=ssrc:' + rtx + ' cname:' + cname + '\r\n' +
            'a=ssrc:' + rtx + ' msid:' + msid + '\r\n'
      }
      // Add SIM group
      sdp += 'a=ssrc-group:SIM ' + ssrcs.join(' ') + '\r\n'

      logger.info('Simulcast setted')
      logger.debug('Simulcast SDP: ', sdp)
      return sdp
    } catch (e) {
      logger.error('Error setting SDP for simulcast: ', e)
      throw e
    }
  },

  /**
   * @function
   * @name setStereo
   * @description Parse SDP for support stereo.
   * @param {String} sdp - Current SDP.
   * @returns {String} SDP parsed with stereo support.
   * @example SdpParser.setStereo(sdp)
   */
  setStereo (sdp) {
    logger.info('Replacing SDP response for support stereo')
    sdp = sdp.replace(
      /useinbandfec=1/g,
      'useinbandfec=1; stereo=1'
    )
    logger.info('Replaced SDP response for support stereo')
    logger.debug('New SDP value: ', sdp)
    return sdp
  },

  /**
   * @function
   * @name setDTX
   * @description Set DTX (Discontinuous Transmission) to the connection. Advanced configuration of the opus audio codec that allows for a large reduction in the audio traffic. For example, when a participant is silent, the audio packets won't be transmitted.
   * @param {String} sdp - Current SDP.
   * @returns {String} SDP parsed with dtx support.
   * @example SdpParser.setDTX(sdp)
   */
  setDTX (sdp) {
    logger.info('Replacing SDP response for support dtx')
    sdp = sdp.replace(
      'useinbandfec=1',
      'useinbandfec=1; usedtx=1'
    )
    logger.info('Replaced SDP response for support dtx')
    logger.debug('New SDP value: ', sdp)
    return sdp
  },

  /**
   * @function
   * @name setAbsoluteCaptureTime
   * @description Mangle SDP for adding absolute capture time header extension.
   * @param {String} sdp - Current SDP.
   * @returns {String} SDP mungled with abs-capture-time header extension.
   * @example SdpParser.setAbsoluteCaptureTime(sdp)
   */
  setAbsoluteCaptureTime (sdp) {
    const id = SdpParser.getAvailableHeaderExtensionIdRange(sdp)[0]
    const header = 'a=extmap:' + id + ' http://www.webrtc.org/experiments/rtp-hdrext/abs-capture-time\r\n'

    const regex = /(m=.*\r\n(?:.*\r\n)*?)(a=extmap.*\r\n)/gm

    sdp = sdp.replace(regex, (match, p1, p2) => p1 + header + p2)

    logger.info('Replaced SDP response for setting absolute capture time')
    logger.debug('New SDP value: ', sdp)

    return sdp
  },

  /**
   * @function
   * @name setDependencyDescriptor
   * @description Mangle SDP for adding dependency descriptor header extension.
   * @param {String} sdp - Current SDP.
   * @returns {String} SDP mungled with abs-capture-time header extension.
   * @example SdpParser.setAbsoluteCaptureTime(sdp)
   */
  setDependencyDescriptor (sdp) {
    const id = SdpParser.getAvailableHeaderExtensionIdRange(sdp)[0]
    const header = 'a=extmap:' + id + ' https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension\r\n'

    const regex = /(m=.*\r\n(?:.*\r\n)*?)(a=extmap.*\r\n)/gm

    sdp = sdp.replace(regex, (match, p1, p2) => p1 + header + p2)

    logger.info('Replaced SDP response for setting depency descriptor')
    logger.debug('New SDP value: ', sdp)

    return sdp
  },

  /**
   * @function
   * @name setVideoBitrate
   * @description Parse SDP for desired bitrate.
   * @param {String} sdp - Current SDP.
   * @param {Number} bitrate - Bitrate value in kbps or 0 for unlimited bitrate.
   * @returns {String} SDP parsed with desired bitrate.
   * @example SdpParser.setVideoBitrate(sdp, 1000)
   */
  setVideoBitrate (sdp, bitrate) {
    if (bitrate &lt; 1) {
      logger.info('Remove bitrate restrictions')
      sdp = sdp.replace(/b=AS:.*\r\n/, '').replace(/b=TIAS:.*\r\n/, '')
    } else {
      const offer = SDPInfo.parse(sdp)
      const videoOffer = offer.getMedia('video')

      logger.info('Setting video bitrate')
      videoOffer.setBitrate(bitrate)
      sdp = offer.toString()
    }
    return sdp
  },

  /**
   * @function
   * @name removeSdpLine
   * @description Remove SDP line.
   * @param {String} sdp - Current SDP.
   * @param {String} sdpLine - SDP line to remove.
   * @returns {String} SDP without the line.
   * @example SdpParser.removeSdpLine(sdp, 'custom line')
   */
  removeSdpLine (sdp, sdpLine) {
    logger.debug('SDP before trimming: ', sdp)
    sdp = sdp
      .split('\n')
      .filter((line) => {
        return line.trim() !== sdpLine
      })
      .join('\n')
    logger.debug('SDP trimmed result: ', sdp)
    return sdp
  },

  /**
   * @function
   * @name adaptCodecName
   * @description Replace codec name of a SDP.
   * @param {String} sdp - Current SDP.
   * @param {String} codec - Codec name to be replaced.
   * @param {String} newCodecName - New codec name to replace.
   * @returns {String} SDP updated with new codec name.
   */
  adaptCodecName (sdp, codec, newCodecName) {
    if (!sdp) {
      return sdp
    }
    const regex = new RegExp(`${codec}`, 'i')

    return sdp.replace(regex, newCodecName)
  },

  /**
   * @function
   * @name setMultiopus
   * @description Parse SDP for support multiopus.
   * **Only available in Google Chrome.**
   * @param {String} sdp - Current SDP.
   * @param {MediaStream} mediaStream - MediaStream offered in the stream.
   * @returns {String} SDP parsed with multiopus support.
   * @example SdpParser.setMultiopus(sdp, mediaStream)
   */
  setMultiopus (sdp, mediaStream) {
    const browserData = new UserAgent()
    if (!browserData.isFirefox() &amp;&amp; (!mediaStream || hasAudioMultichannel(mediaStream))) {
      if (!sdp.includes('multiopus/48000/6')) {
        logger.info('Setting multiopus')
        // Find the audio m-line
        const res = /m=audio 9 UDP\/TLS\/RTP\/SAVPF (.*)\r\n/.exec(sdp)
        // Get audio line
        const audio = res[0]
        // Get free payload number for multiopus
        const pt = SdpParser.getAvailablePayloadTypeRange(sdp)[0]
        // Add multiopus
        const multiopus = audio.replace('\r\n', ' ') + pt + '\r\n' +
              'a=rtpmap:' + pt + ' multiopus/48000/6\r\n' +
              'a=fmtp:' + pt + ' channel_mapping=0,4,1,2,3,5;coupled_streams=2;minptime=10;num_streams=4;useinbandfec=1\r\n'
        // Change sdp
        sdp = sdp.replace(audio, multiopus)
        logger.info('Multiopus offer created')
        logger.debug('SDP parsed for multioups: ', sdp)
      } else {
        logger.info('Multiopus already setted')
      }
    }
    return sdp
  },

  /**
   * @function
   * @name getAvailablePayloadTypeRange
   * @description Gets all available payload type IDs of the current Session Description.
   * @param {String} sdp - Current SDP.
   * @returns {Array&lt;Number>} All available payload type ids.
   */
  getAvailablePayloadTypeRange (sdp) {
    const regex = /m=(?:.*) (?:.*) UDP\/TLS\/RTP\/SAVPF (.*)\r\n/gm

    const matches = sdp.matchAll(regex)
    let ptAvailable = payloadTypeUppperRange.concat(payloadTypeLowerRange)

    for (const match of matches) {
      const usedNumbers = match[1].split(' ').map(n => parseInt(n))
      ptAvailable = ptAvailable.filter(n => !usedNumbers.includes(n))
    }

    return ptAvailable
  },

  /**
   * @function
   * @name getAvailableHeaderExtensionIdRange
   * @description Gets all available header extension IDs of the current Session Description.
   * @param {String} sdp - Current SDP.
   * @returns {Array&lt;Number>} All available header extension IDs.
   */
  getAvailableHeaderExtensionIdRange (sdp) {
    const regex = /a=extmap:(\d+)(?:.*)\r\n/gm

    const matches = sdp.matchAll(regex)
    let idAvailable = headerExtensionIdLowerRange.concat(headerExtensionIdUppperRange)

    for (const match of matches) {
      const usedNumbers = match[1].split(' ').map(n => parseInt(n))
      idAvailable = idAvailable.filter(n => !usedNumbers.includes(n))
    }

    return idAvailable
  },

  /**
   * @function
   * @name renegotiate
   * @description Renegotiate remote sdp based on previous description.
   * This function will fill missing m-lines cloning on the remote description by cloning the codec and extensions already negotiated for that media
   * @param {String} localDescription - Updated local sdp
   * @param {String} remoteDescription - Previous remote sdp
   */
  renegotiate (localDescription, remoteDescription) {
    const offer = SDPInfo.parse(localDescription)
    const answer = SDPInfo.parse(remoteDescription)

    // Check all transceivers on the offer are on the answer
    for (const offeredMedia of offer.getMedias()) {
      // Get associated mid on the answer
      let answeredMedia = answer.getMediaById(offeredMedia.getId())
      // If not found in answer
      if (!answeredMedia) {
        // Create new one
        answeredMedia = new MediaInfo(offeredMedia.getId(), offeredMedia.getType())
        // Set direction
        answeredMedia.setDirection(Direction.reverse(offeredMedia.getDirection()))
        // Find first media line for same kind
        const first = answer.getMedia(offeredMedia.getType())
        // If found
        if (first) {
          // Copy codec info
          answeredMedia.setCodecs(first.getCodecs())
          // Copy extension info
          for (const [id, extension] of first.getExtensions()) {
            // Add it
            answeredMedia.addExtension(id, extension)
          }
        }
        // Add it to answer
        answer.addMedia(answeredMedia)
      }
    }

    return answer.toString()
  },

  /**
   * @function
   * @name updateMissingVideoExtensions
   * @description Adds missing extensions of each video section in the localDescription
   * @param {String} localDescription - Previous local sdp
   * @param {String} remoteDescription - Remote sdp
   * @returns {String} SDP updated with missing extensions.
   */
  updateMissingVideoExtensions (localDescription, remoteDescription) {
    const offer = SDPInfo.parse(localDescription)
    const answer = SDPInfo.parse(remoteDescription)
    // Get extensions of answer
    const remoteVideoExtensions = answer.getMediasByType('video')[0]?.getExtensions()
    if (!remoteVideoExtensions &amp;&amp; !remoteVideoExtensions.length) {
      return
    }
    for (const offeredMedia of offer.getMediasByType('video')) {
      const offerExtensions = offeredMedia.getExtensions()
      remoteVideoExtensions.forEach((val, key) => {
        // If the extension is not present in offer then add it
        if (!offerExtensions.get(key)) {
          const id = offeredMedia.getId()
          const header = 'a=extmap:' + key + ' ' + val + '\r\n'
          const regex = new RegExp('(a=mid:' + id + '\r\n(?:.*\r\n)*?)', 'g')
          localDescription = localDescription.replace(regex, (_, p1, p2) => p1 + header)
        }
      })
    }
    return localDescription
  },
  getCodecPayloadType (sdp) {
    const reg = /a=rtpmap:(\d+) (\w+)\/\d+/g
    const matches = sdp.matchAll(reg)
    const codecMap = {}

    for (const match of matches) {
      codecMap[match[1]] = match[2]
    }
    return codecMap
  }
}

// Checks if mediaStream has more than 2 audio channels.
const hasAudioMultichannel = (mediaStream) => {
  return mediaStream.getAudioTracks().some(value => value.getSettings().channelCount > 2)
}

export default SdpParser
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Millicast SDK</a><div class="mobile-nav-links"><div class="navbar-item"><a id="" href="https://github.com/millicast/millicast-sdk" target="_blank">Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/@millicast/sdk" target="_blank">NPM Package</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Director.html">Director</a></div><div class="sidebar-section-children"><a href="module-Logger.html">Logger</a></div><div class="sidebar-section-children"><a href="module-SdpParser.html">SdpParser</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html">BaseWebRTC</a></div><div class="sidebar-section-children"><a href="PeerConnection.html">PeerConnection</a></div><div class="sidebar-section-children"><a href="Publish.html">Publish</a></div><div class="sidebar-section-children"><a href="Signaling.html">Signaling</a></div><div class="sidebar-section-children"><a href="View.html">View</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-events"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BaseWebRTC.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:connectionStateChange">connectionStateChange</a></div><div class="sidebar-section-children"><a href="PeerConnection.html#event:track">track</a></div><div class="sidebar-section-children"><a href="Publish.html#event:reconnect">reconnect</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:broadcastEvent">broadcastEvent</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionClose">wsConnectionClose</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionError">wsConnectionError</a></div><div class="sidebar-section-children"><a href="Signaling.html#event:wsConnectionSuccess">wsConnectionSuccess</a></div><div class="sidebar-section-children"><a href="View.html#event:metadata">metadata</a></div><div class="sidebar-section-children"><a href="View.html#event:reconnect">reconnect</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#AudioCodec">AudioCodec</a></div><div class="sidebar-section-children"><a href="global.html#ConnectionStats">ConnectionStats</a></div><div class="sidebar-section-children"><a href="global.html#DRMOptions">DRMOptions</a></div><div class="sidebar-section-children"><a href="global.html#DirectorPublisherOptions">DirectorPublisherOptions</a></div><div class="sidebar-section-children"><a href="global.html#DirectorSubscriberOptions">DirectorSubscriberOptions</a></div><div class="sidebar-section-children"><a href="global.html#FrameMetaData">FrameMetaData</a></div><div class="sidebar-section-children"><a href="global.html#InboundStats">InboundStats</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LayerInfo">LayerInfo</a></div><div class="sidebar-section-children"><a href="global.html#LogLevel">LogLevel</a></div><div class="sidebar-section-children"><a href="global.html#MillicastCapability">MillicastCapability</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#MillicastDirectorResponse">MillicastDirectorResponse</a></div><div class="sidebar-section-children"><a href="global.html#OutboundStats">OutboundStats</a></div><div class="sidebar-section-children"><a href="global.html#PeerConnectionConfig">PeerConnectionConfig</a></div><div class="sidebar-section-children"><a href="global.html#SEIPicTimingTimeCode">SEIPicTimingTimeCode</a></div><div class="sidebar-section-children"><a href="global.html#SEIUserUnregisteredData">SEIUserUnregisteredData</a></div><div class="sidebar-section-children"><a href="global.html#SignalingPublishOptions">SignalingPublishOptions</a></div><div class="sidebar-section-children"><a href="global.html#SignalingSubscribeOptions">SignalingSubscribeOptions</a></div><div class="sidebar-section-children"><a href="global.html#TrackReport">TrackReport</a></div><div class="sidebar-section-children"><a href="global.html#VideoCodec">VideoCodec</a></div><div class="sidebar-section-children"><a href="global.html#addPeerEvents">addPeerEvents</a></div><div class="sidebar-section-children"><a href="global.html#extractH26xMetadata">extractH26xMetadata</a></div><div class="sidebar-section-children"><a href="global.html#loggerHandler">loggerHandler</a></div><div class="sidebar-section-children"><a href="global.html#parseWebRTCStats">parseWebRTCStats</a></div><div class="sidebar-section-children"><a href="global.html#tokenGeneratorCallback">tokenGeneratorCallback</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>